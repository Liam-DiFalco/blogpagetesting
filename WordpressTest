#!/bin/bash

# Set up variables
WEB_DIR="/usr/share/nginx/html"
WORDPRESS_ZIP="latest.zip"
WORDPRESS_URL="https://wordpress.org/$WORDPRESS_ZIP"
DB_DIR="$(pwd)/mysql_data"  # Subdirectory for MySQL data
DB_NAME="wordpress_db"
DB_USER="wordpress_user"
DB_PASSWORD="your_password"

# Update system packages
echo "Updating system packages..."
sudo yum update -y

# Install Nginx, PHP, and required extensions
echo "Installing Nginx, PHP, and required extensions..."
sudo yum install -y nginx php php-fpm php-mysqlnd php-xml php-mbstring php-json unzip

# Start and enable Nginx
echo "Starting and enabling Nginx..."
sudo systemctl start nginx
sudo systemctl enable nginx

# Configure PHP to work with Nginx
echo "Configuring PHP to work with Nginx..."
sudo sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php.ini
sudo systemctl start php-fpm
sudo systemctl enable php-fpm

# Download WordPress
echo "Downloading WordPress..."
cd "$WEB_DIR"
sudo wget -O "$WORDPRESS_ZIP" "$WORDPRESS_URL"

# Check if the download was successful
if [ -f "$WORDPRESS_ZIP" ]; then
    echo "Removing any existing WordPress directories..."
    sudo rm -rf "$WEB_DIR/wordpress"  # Remove previous WordPress folders if they exist

    echo "Extracting WordPress..."
    sudo unzip -o "$WORDPRESS_ZIP"

    echo "Moving WordPress files to the web directory..."
    sudo mv "$WEB_DIR/wordpress/"* "$WEB_DIR/"  # Move all files to the web root
    sudo rm -rf "$WEB_DIR/wordpress"  # Remove the now-empty directory
    sudo rm "$WORDPRESS_ZIP"  # Clean up the zip file after extraction
else
    echo "Error: Failed to download WordPress. Please check the download URL."
    exit 1
fi

# Create MySQL database directory
echo "Creating MySQL database directory at $DB_DIR..."
mkdir -p "$DB_DIR"

# Install MySQL server
echo "Installing MariaDB..."
sudo yum install -y mariadb-server

# Start and enable MariaDB
echo "Starting and enabling MariaDB..."
sudo systemctl start mariadb
sudo systemctl enable mariadb

# Secure MariaDB installation
echo "Securing MariaDB installation..."
sudo mysql_secure_installation

# Create a MySQL database and user
echo "Creating MySQL database and user..."
sudo mysql -e "CREATE DATABASE $DB_NAME DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;"
sudo mysql -e "CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASSWORD';"
sudo mysql -e "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'localhost';"
sudo mysql -e "FLUSH PRIVILEGES;"

# Configure MySQL to use the custom data directory
echo "Configuring MySQL to use the custom data directory..."
sudo systemctl stop mariadb
sudo mv /var/lib/mysql "$DB_DIR"  # Move the existing MySQL data directory
sudo ln -s "$DB_DIR/mysql" /var/lib/mysql  # Create a symlink
sudo chown -R mysql:mysql "$DB_DIR/mysql"  # Fix ownership

# Start MariaDB
echo "Starting MariaDB..."
sudo systemctl start mariadb

# Set up Nginx for WordPress
echo "Removing the default Nginx configuration to avoid conflicts..."
sudo rm -f /etc/nginx/conf.d/default.conf

echo "Creating a custom Nginx configuration for WordPress..."
sudo bash -c "cat > /etc/nginx/conf.d/wordpress.conf" <<EOL
server {
    listen 80;
    server_name _;

    root $WEB_DIR;
    index index.php index.html index.htm;

    location / {
        try_files \$uri \$uri/ /index.php?\$args;
    }

    location ~ \.php$ {
        include /etc/nginx/fastcgi_params;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOL

# Configure firewall to allow HTTP and HTTPS traffic
echo "Configuring firewall to allow HTTP and HTTPS traffic."
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

# Test Nginx configuration
echo "Testing Nginx configuration"
sudo nginx -t

# Restart Nginx to apply changes
echo "Restarting Nginx to apply changes"
sudo systemctl restart nginx

# Final message
echo "WordPress setup finished..."
echo "Visit http://10.0.5.10 to complete the WordPress installation."
